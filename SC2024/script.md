# Intro

# Intake-esgf

Read in 3:12

- The following provides an introduction to intake-esgf: a python package providing a programmatic interface to the ESGF holdings.
- ESGF holdings are vast and so our catalogs initialize empty. They are populated using the catalog search function and providing facets or keywords with search criteria. In this example we are searching for monthly mean output from the Canadian model that was run from 1850 to 2015. We would like the gross primary productivty, surface air temperature, and precipitation variables. This function queries a configurable set of indices and returns merged results in the form of a pandas dataframe.
- This dataframe is directly accessible to the user as a property of the catalog object. The user can then manipulate the dataframe by removing rows in order to hone the search to some desired selection.
- Alternatively, the user can print the catalog to view the columns and unique values of the underlying dataframe, utilizing this information to refine the search.
- In this case, we realize that we neglected to specify the ensemble member. We repeat our search with this additional constraint which leads to our intended result. 
- Once the catalog contains the desired datasets, they may be loaded into memory with the to_dataset_dict() catalog function. Internally we are communicating again with the index nodes to consolidate access methods and locations for all the files that are part of each dataset.
- We use the following logic to determine how we will transfer or load your datasets. First, if a file already exists locally, we will simply load it. This may be because the file is already in the cache from a previous use of intake-esgf. It may also be because the user is working on a resource with direct access to the file. Second, if the user has indicated a preference to stream data and such access methods are available, we will harvest and provide these paths. Third, if the user has a destination Globus endpoint to which they prefer to download the data, they may provide the UUID to initiate a Globus transfer. As a last resort, we will download the remaining files using a threaded https transfer.
- The to_dataset_dict() function returns a dictionary of datasets whose keys are formed from the different facet values of the datasets returned. In this case it uses the table_id and the variable_id. Note that intake-esgf also automatically includes cell measures which in this case is areacella.
- As a demonstration, we present a simple python code to plot the temporal mean of each variable using matplotlib. From left to right we plot the temperature, precipitation, and gross primary productivity.
- The programmatic nature of the interface is important because it allows the user to have a conversation with the index and learn what data may be appropriate to their science question. It also hides the complexity about how the data is stored or made available to the user and automates many painful tasks. The interface also makes user scripts portable across systems, particularly important as server-side and data-proximate computing options become available.

# Rooki

- Hello and now we are going to look at an example of how we can use intake-esgf in combination with a package called rooki to do some server-side computing.
- First we import the things that we are going to need right into our script. They are kind of the non-rooki things first. And underneath that we import the rooki options. Now, before we do that we want to set an environment variable. You could of course set this outside of your script but here we add it in programmatically and this makes sure that rooki points at the right web processing services in this case the one that we have stood up at ORNL.
- Because we are using the ORNL deployment, we want to configure intake-esgf to only look at holdings we have there and so we configure the indices we are searching.
- And now we go search for some data. In this case we are looking for temperature data from a couple of models. Again we specify the data node is 
for data local to ORNL.
- Once we have that search, we can take the id quantity that sits in the dataframe and we can apply a transformation to that. intake-esgf returns back a list of ids where data can be found. In our case we are interested in the first entry in that list. The data ids include a |esgf-node.ornl.gov that we are going to remove. Then we will prepend the id with a ccs03_data. That forms an id that rooki can use remotely load data automatically and so here you see what the IDs look like. What they are is less important and how you use them is more important.
- What we are going to do is rooki allows us to operate serverside with a set of operators, and so in this case it is everything in the namespace `ops` that we have imported. We're using the input first where we pass in a rooki id. Then we are going to subset. In this case we are subsetting from 1990 to 2000 and the area is specifying a latitude longitude box around europe in this case. And then we can also apply over that the averagebytime and in this case we are going to do that on a annual basis. And so we define this workflow in a nested fashion and then tell rooki to orchestrate that workflow. We check that the response is ok and if so return what the datasets are. Otherwise it will return an exception that explains what went wrong from the rooki client. 
- When you execute this function on all your rooki ids, each one individually, you are going to get some message that tells you where the data has been downloaded, when it says it is downloading it, it means the data that has been subset and averaged. It did all of that remotely and in this case I am returning a dictionary of the datasets who keys are the model names.
- We make plots using matplotlib. You see that the colder temperatures up in the high Alp region from these 4 different models.
- Some key points here, this is a great solution if the user task fits into the set of operators that rooki implements. It is great becaues you can greatly minimize data transfer, only moving the stuff that you really need. And in this case intake-esgf is really just used to form those ids that rooki is going to use serverside to figure out which data to load.

# Globus Compute 